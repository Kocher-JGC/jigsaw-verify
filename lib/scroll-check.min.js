(function(a,b){typeof exports==='object'&&typeof module!=='undefined'?module.exports=b():typeof define==='function'&&define.amd?define(b):(a.initScrollCheck=b())}(this,(function(){const P=Promise;const E=console.error;const isD=v=>v!==undefined&&v!==null;const iF=v=>v===false;const jT=(a,b)=>typeof a==b;const rNB=(a,b)=>Math.floor(Math.random()*(b-a))+a;const RI=s=>new P((r,j)=>{const i=new Image();i.crossOrigin='';i.src=s;i.onload=()=>r(i);i.onerror=()=>j(new Error('loadImgFailed'+url))});const gD=a=>{let t=typeof a;let m;if(t=='string'){m=a.match(/^[^\d][.#-\dA-Za-z]+/)||false;return m&&m[0].length==a.length?document.querySelector(a):false}return t=='object'?a:false};const sUI=(a,w,h)=>{let r={},d;if(a instanceof CanvasRenderingContext2D){r.dom=a.canvas;r.input=a;r.inputType='canvas'}else{if(jT(a,'string'))d=gD(a);d=d||a;if(d&&d.nodeType===1){r.dom=d;switch(d.nodeName.toLowerCase()){case'canvas':r.inputType='canvas';r.input=d.getContext('2d');break;case'img':r.inputType='img';break;case'input':r.inputType='input';break;default:return false}}else{return false}}if(r.inputType!='input'){if(isD(w)){r.w=w;if(isD(r.input))r.input.width=w;r.dom.style.width=w+'px'}else{r.w=(r.dom||r.input).offsetWidth}if(isD(h)){r.h=h;if(isD(r.input))r.input.height=h;r.dom.style.height=h+'px'}else{r.h=(r.dom||r.input).offsetHeight}}return r};const iC=(c,w,h)=>{let r={},d;c=c||'';if(c instanceof CanvasRenderingContext2D){r.ctx=c;d=c.canvas}else{d=jT(c,'string')?gD(c):c;let n=true;if(d.nodeType==1)n=c.tagName.toLowerCase();if(n!='canvas'){d=document.createElement('canvas');if(iF(n))c.appendChild(d)}r.ctx=d.getContext('2d')}w=w||d.offsetWidth||320;h=h||d.offsetHeight||200;d.style.width=w+'px';d.style.height=h+'px';r.w=r.ctx.width=d.width=w;r.h=r.ctx.height=d.height=h;return r};function ps(l,n){let a=Array.from({length:l}).map((_,i)=>i),i=1,ix;l--;for(;i<=l;i++){ix=(i*2)%l;[a[ix],a[i]]=[a[i],a[ix]]}function r(a,f,t){for(;f<t;++f,--t)[a[f],a[t]]=[a[t],a[f]];return a}return n%l%0==0?r(a,0,n%l):r(a,n%l,l)};function mTA(w,h,n){let r=[],pA=[];let sA=[2,3,4,5,6,7].reduce((r,v)=>{if(h%v==0)r.push(v);return r},[1]);for(let i=29;i>=14;i--){if(w%i==0){pA.push(i)}}r[2]=pA[n%(pA.length)];r[3]=sA[n%(sA.length)];if(!isD(r[2])){E('error the input width is prime number your will change it');r[2]=w;r[3]=1}r[0]=w/r[2];r[1]=h/r[3];return r};function tD(c,a,n){let tfA=[],cS=false,nS;!isD(n)?n=rNB(0,rNB(4,66666)):cS=true;if(a.length==2){a=mTA(a[0],a[1],n)}else{a[0]=a[0]/a[2];a[1]=a[1]/a[3]}let[w,h,p,s]=a;let pA=ps(p*s,n);if(cS){pA.forEach((_,i)=>{nS=Math.floor(i/p);tfA[_]=c.getImageData(w*(i-nS*p),h*nS,w,h)})}else{pA.forEach(_=>{nS=Math.floor(_/p);tfA.push(c.getImageData(w*(_-nS*p),h*nS,w,h))})};tfA.forEach((_,i)=>{nS=Math.floor(i/p);c.putImageData(_,w*(i-nS*p),h*nS)});return n};const mP=(bC,w,h)=>{let r=[bC.p+bC.w/3*2|0,w-bC.p-6/5*bC.w|0,h-bC.p-6/5*bC.h|0];bC.range=r;let fC=[rNB(r[0],r[1]),rNB(r[0],r[2])];let c=[fC,[fC[0]+bC.w,fC[1]],[fC[0]+bC.w,fC[1]+bC.h],[fC[0],fC[1]+bC.h]];bC.coord=c;bC.mid=[(fC[0]+bC.w/2)|0,(fC[1]+bC.h/2)|0];bC.cut=[c[0][0]-bC.r-bC.p,0,bC.w+2*(bC.r+bC.p),h];return bC.cut[0]};const mD=d=>{d=d||{};return['top','right','bottom','left'].reduce((r,v)=>{r[v]=jT(d[v],'boolean')?d[v]?1:0:Math.random()>.5?1:0;return r},{})};const iCC=(c)=>{const K=['padding','radius','width','height'];let bC={p:8,r:14,w:72,h:72};K.forEach(k=>{if(c[k])bC[k.substr(0,1)]=c[k]});bC.oDirection=c.direction;return bC};const _dP=(c,cf)=>{if(!c)return;const cd=cf.coord;c.beginPath();c.moveTo(cd[0][0],cd[0][1]);['top','right','bottom','left'].forEach((v,i)=>{let d;let nD=cf.direction[v];let x1,x2,x3,y1,y2,y3,r,m;r=i>>1?-cf.r:cf.r;if(i%2){m=cf.mid[1];d=i>>1^nD?cf.r:-cf.r;x1=cd[i][0];x2=x3=cd[i][0]+d;y1=m-r;y2=m+r;y3=m;c.lineTo(x1,y1);c.arcTo(x2,y1,x3,y3,cf.r);c.arcTo(x2,y2,x1,y2,cf.r);c.lineTo(x1,y2)}else{m=cf.mid[0];d=i%3>>1^nD?-cf.r:cf.r;x1=m-r;x2=m+r;x3=m;y1=cd[i][1];y2=y3=cd[i][1]+d;c.lineTo(x1,y1);c.arcTo(x1,y2,x3,y3,cf.r);c.arcTo(x2,y2,x2,y1,cf.r);c.lineTo(x2,y1)};if(i!==3)c.lineTo(cd[i+1][0],cd[i+1][1])});c.closePath()};const _cJ=c=>{if(!c)return;c.shadowColor='black';c.shadowBlur=10;c.lineWidth=.45;c.strokeStyle='#fff9e6';c.save();c.stroke();c.globalCompositeOperation='destination-in';c.fill();c.globalCompositeOperation='source-over';let sum=8;while(sum--){c.restore();c.stroke()}c.restore()};const _dS=(c,cf)=>{if(!c)return;let sC='30,30,30';let m=cf.mid;c.shadowColor=`rbga(${sC},.7)`;c.shadowBlur=10;c.shadowOffsetX=c.shadowOffsetY=4;c.lineWidth=1.6;c.strokeStyle='#fff9e6';c.stroke();c.save();let g=c.createRadialGradient(m[0],m[1],cf.w,m[0],m[1],3);g.addColorStop(0,`rgba(0,0,0,1)`);g.addColorStop(.3,`rgba(10,10,10,.9)`);g.addColorStop(.5,`rgba(${sC},.6)`);g.addColorStop(1,`rgba(${sC},.2)`);c.fillStyle=g;c.fill();c.restore()};function SC(a){if(this instanceof SC){this._(a)}}SC.prototype={constructor:SC,_(opts){let w=opts.width,h=opts.height;const iR=sUI(opts.input,w,h);if(iR){w=iR.w||w;h=iR.h||h;this.input=iR.input||iR.dom;this.inputType=iR.inputType}else if(opts.createConfig){return E('No input and can’t CreateScrollCheck')}let c=iC(opts.ctx,w,h);let p=opts.piece,s=opts.segment,hS=isD(opts.scrollCtx);w=c.w;h=c.h;this.w=w;this.h=h;this.ctx=c.ctx;this.scrollCtx=hS?iC(opts.scrollCtx,w,h).ctx:c.ctx;if(!hS)this.ctxEqual=true;this.trimArr=[w,h];if(isD(p)&&isD(s)){if(w%p==0&&h%s==0){this.trimArr[2]=p;this.trimArr[3]=s}else{E('invalid piece or sengment.It will be generated automatically!')}}if(opts.createConfig){this.bC=iCC(opts.createConfig);this._iCSC(opts.changeCallback,opts.autoMakeData)}if(opts.handlerScrollDom){this.moveStop=opts.moveStop||false;this.initHandlerScrollDom(opts.handlerScrollDom,opts.offsetScroll,opts.scrrollContainer)}if(opts.scrollData&&opts.finishData&&opts.coefficient){this.finishData=opts.finishData;this.scrollData=opts.scrollData;this.coefficient=opts.coefficient;this.originalData=opts.originalData;this.putData()}},_iCSC(cC,iM){this.iniCutConfig=()=>{const bC=Object.assign({},this.bC);this.verifyValue=mP(bC,this.w,this.h);bC.direction=mD(bC.oDirection);this.config=bC;return this.verifyValue};this.getScrollData=(c)=>{c=c||this.scrollCtx;c.putImageData(this.originalData,0,0);_dP(c,this.config);_cJ(c);this.scrollData=c.getImageData(...this.config.cut);let tC=iC('',this.scrollData.width,this.scrollData.height).ctx;tC.putImageData(this.scrollData,0,0);return this.scrollUrl=tC.canvas.toDataURL()};this.getFinishData=(c)=>{c=c||this.ctx;_dP(c,this.config);_dS(c,this.config);this.coefficient=tD(c,this.trimArr);this.finishData=c.getImageData(0,0,this.w,this.h);this.finishUrl=c.canvas.toDataURL();return{coefficient:this.coefficient,dataURL:this.finishUrl,}};this.putCreateOriginalData=i=>{if(!i){i=this.inputType=='canvas'?this.input.getImageData(0,0,this.w,this.h):this.input}if(i){if(i.data){this.ctx.putImageData(i,0,0)}else{this.ctx.drawImage(i,0,0,this.w,this.h)}}return this.originalData=this.ctx.getImageData(0,0,this.w,this.h)};this.autoMakeData=()=>{this.verifyValue=this.iniCutConfig();if(this.inputType!='input')this.putCreateOriginalData();this.getScrollData();if(this.ctxEqual)this.reDrawCreateCtx();this.getFinishData();if(this.ctxEqual)this.reDrawCreateCtx();if(iM)this.drawScrollCheck()};this.reDrawCreateCtx=()=>this.ctx.putImageData(this.originalData,0,0);if(this.inputType=='input'){this.input.onchange=event=>{const r=new FileReader();r.readAsDataURL(this.input.files[0]);r.onload=e=>RI(e.target.result).then(i=>{this.putCreateOriginalData(i);if(iM)this.autoMakeData();cC&&cC(e.target.result,i)})}}else{if(iM)this.autoMakeData()}},putData(){this.putScrollData();this.putFinishData();this.putOriginalData()},putScrollData(sD,w,h){sD=sD||this.scrollData;this.scrollCtx.clearRect(0,0,this.w,this.h);this.getCtxImageData(sD,w,h).then(_d=>{this.scrollData=_d;this.scrollCtx.putImageData(_d,0,0)})},putFinishData(fD,w,h){fD=fD||this.finishData;this.ctx.clearRect(0,0,this.w,this.h);this.getCtxImageData(fD,w,h).then(_d=>{this.finishData=_d;this.ctx.putImageData(_d,0,0);tD(this.ctx,this.trimArr,this.coefficient)})},putOriginalData(oD,w,h){oD=oD||this.originalData;oD&&this.getCtxImageData(oD,w,h).then(_d=>{this.originalData=_d})},getCtxImageData(cI,w,h){let r;w=w||this.w;h=h||this.h;const giD=(img)=>{let oD=this.ctx.getImageData(0,0,w,h);this.ctx.drawImage(img,0,0,w,h);let d=this.ctx.getImageData(0,0,w,h);this.ctx.putImageData(oD,0,0);return d};if(cI instanceof ImageData){r=cI}else if(cI.nodeType==1&&cI.tagName.toLowerCase()=='img'){r=giD(cI)}else if(jT(cI,'string')){let img=gD(cI);if(!img){return RI(cI).then(i=>{return new P(res=>res(giD(i)))})}else{r=giD(img)}};return new P((res,rej)=>{res(r)})},initHandlerScrollDom(d,o=0,sc){d=gD(d);sc=gD(sc);if(!sc)sc=d;if(d){let offsetX,canDraw=false;const r=[o,this.w-d.offsetWidth-o];d.addEventListener('mousedown',(e)=>{canDraw=true;offsetX=e.pageX},false);sc.addEventListener('mousemove',(e)=>{if(canDraw){let move=e.pageX-offsetX;if(move>=r[0]&&move<=r[1]){d.style.transform=`translate(${move}px,0px)`;this.drawScrollCheck(move)}}},false);const cancelHandle=e=>{canDraw=false;offsetX=0;d.style.transform=`translate(${r[0]}px,0px)`;this.drawScrollCheck(0)};sc.addEventListener('mouseup',e=>{canDraw=false;let move=e.pageX-offsetX;typeof this.moveStop=='function'?this.moveStop(cancelHandle,move,e):cancelHandle(e)},false);sc.addEventListener('mouseleave',cancelHandle,false)}else{E('initHandlerScrollDom failed!')}},drawScrollCheck(o=0){if(this.scrollData){this.scrollCtx.clearRect(0,0,this.w,this.h);this.scrollCtx.putImageData(this.scrollData,o,0)}}};function initScrollCheck(a){if(window.document.createElement('canvas').getContext){return new SC(a)}else{let msg='Your browser doesn’t support HTML5!\nRecommend use Chrome 14+/IE 9+/Firefox 7+/Safari 4+';E(msg);alert(msg);return{}}};return initScrollCheck})));