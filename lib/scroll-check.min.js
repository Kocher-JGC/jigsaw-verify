!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define(factory):global.initScrollCheck=factory()}(this,function(){const error=console.error,isDef=v=>null!=v,isFalse=v=>!1===v,judgeType=(any,type)=>typeof any==type,randomNumBoth=(min,max)=>Math.floor(Math.random()*(max-min))+min,renderImg=src=>new Promise((resolve,reject)=>{const image=new Image;image.crossOrigin="",image.src=src,image.onload=(()=>resolve(image)),image.onerror=(e=>reject(new Error("loadImgFailed"+src)))}),getDom=str=>{let type=typeof str;let match;if(type=='string'){try{return document.querySelector(str)}catch(e){return false}}return type=='object'?str:false},shuldUseInput=(input,w,h)=>{let result={},dom;if(input instanceof CanvasRenderingContext2D)result.dom=input.canvas,result.input=input,result.inputType="canvas";else{if(judgeType(input,"string")&&(dom=getDom(input)),!(dom=dom||input)||1!==dom.nodeType)return!1;switch(result.dom=dom,dom.nodeName.toLowerCase()){case"canvas":result.inputType="canvas",result.input=dom.getContext("2d");break;case"img":result.inputType="img";break;case"input":result.inputType="input";break;default:return!1}}return"input"!=result.inputType&&(isDef(w)?(result.w=w,isDef(result.input)&&(result.input.width=w),result.dom.style.width=w+"px"):result.w=(result.dom||result.input).offsetWidth,isDef(h)?(result.h=h,isDef(result.input)&&(result.input.height=h),result.dom.style.height=h+"px"):result.h=(result.dom||result.input).offsetHeight),result},initCanvas=(ctx,w,h)=>{let result={},ctxDom;if((ctx=ctx||"")instanceof CanvasRenderingContext2D)result.ctx=ctx,ctxDom=ctx.canvas;else{let tagName=!0;1==(ctxDom=judgeType(ctx,"string")?getDom(ctx):ctx).nodeType&&(tagName=ctx.tagName.toLowerCase()),"canvas"!=tagName&&(ctxDom=document.createElement("canvas"),isFalse(tagName)&&ctx.appendChild(ctxDom)),result.ctx=ctxDom.getContext("2d")}return w=w||ctxDom.offsetWidth||320,h=h||ctxDom.offsetHeight||200,ctxDom.style.width=w+"px",ctxDom.style.height=h+"px",result.w=result.ctx.width=ctxDom.width=w,result.h=result.ctx.height=ctxDom.height=h,result};function pefect_shuffle(l,n){let arr=Array.from({length:l}).map((_,i)=>i),i=1,index;for(l--;i<=l;i++)index=2*i%l,[arr[index],arr[i]]=[arr[i],arr[index]];function reverse(a,from,to){for(;from<to;++from,--to)[a[from],a[to]]=[a[to],a[from]];return a}return n%l%0==0?reverse(arr,0,n%l):reverse(arr,n%l,l)}function makeTrimArr(w,h,n){let result=[],pieceArr=[],segmentArr=[2,3,4,5,6,7].reduce((res,v)=>(h%v==0&&res.push(v),res),[1]);for(let i=29;i>=14;i--)w%i==0&&pieceArr.push(i);return result[2]=pieceArr[n%pieceArr.length],result[3]=segmentArr[n%segmentArr.length],isDef(result[2])||(error("error the input width is prime number your will change it"),result[2]=w,result[3]=1),result[0]=w/result[2],result[1]=h/result[3],result}function transformData(ctx,trimArr,n){let transformArr=[],canSort=!1,nowSegment;isDef(n)?canSort=!0:n=randomNumBoth(0,randomNumBoth(4,66666)),2==trimArr.length?trimArr=makeTrimArr(trimArr[0],trimArr[1],n):(trimArr[0]=trimArr[0]/trimArr[2],trimArr[1]=trimArr[1]/trimArr[3]);let[w,h,piece,segment]=trimArr,pefectArr=pefect_shuffle(piece*segment,n);return canSort?pefectArr.forEach((_,i)=>{nowSegment=Math.floor(i/piece),transformArr[_]=ctx.getImageData(w*(i-nowSegment*piece),h*nowSegment,w,h)}):pefectArr.forEach(_=>{nowSegment=Math.floor(_/piece),transformArr.push(ctx.getImageData(w*(_-nowSegment*piece),h*nowSegment,w,h))}),transformArr.forEach((_,i)=>{nowSegment=Math.floor(i/piece),ctx.putImageData(_,w*(i-nowSegment*piece),h*nowSegment)}),n}const makeP=(bC,w,h)=>{let range=[bC.p+bC.w/3*2|0,w-bC.p-1.2*bC.w|0,h-bC.p-1.2*bC.h|0];bC.range=range;let fC=[randomNumBoth(range[0],range[1]),randomNumBoth(range[0],range[2])],coord=[fC,[fC[0]+bC.w,fC[1]],[fC[0]+bC.w,fC[1]+bC.h],[fC[0],fC[1]+bC.h]];return bC.coord=coord,bC.mid=[fC[0]+bC.w/2|0,fC[1]+bC.h/2|0],bC.cut=[coord[0][0]-bC.r-bC.p,0,bC.w+2*(bC.r+bC.p),h],bC.cut[0]},makeD=direction=>(direction=direction||{},["top","right","bottom","left"].reduce((result,v)=>(result[v]=judgeType(direction[v],"boolean")?direction[v]?1:0:Math.random()>.5?1:0,result),{})),initCreateConfig=c=>{const K=["padding","radius","width","height"];let bC={p:8,r:14,w:72,h:72};return K.forEach(k=>{c[k]&&(bC[k.substr(0,1)]=c[k])}),bC.oDirection=c.direction,bC},_drawPath=(ctx,c)=>{if(!ctx)return;const coord=c.coord;ctx.beginPath(),ctx.moveTo(coord[0][0],coord[0][1]),["top","right","bottom","left"].forEach((v,i)=>{let diffV,nD=c.direction[v],x1,x2,x3,y1,y2,y3,r,mid;r=i>>1?-c.r:c.r,i%2?(mid=c.mid[1],diffV=i>>1^nD?c.r:-c.r,x1=coord[i][0],x2=x3=coord[i][0]+diffV,y1=mid-r,y2=mid+r,y3=mid,ctx.lineTo(x1,y1),ctx.arcTo(x2,y1,x3,y3,c.r),ctx.arcTo(x2,y2,x1,y2,c.r),ctx.lineTo(x1,y2)):(mid=c.mid[0],diffV=i%3>>1^nD?-c.r:c.r,x1=mid-r,x2=mid+r,x3=mid,y1=coord[i][1],y2=y3=coord[i][1]+diffV,ctx.lineTo(x1,y1),ctx.arcTo(x1,y2,x3,y3,c.r),ctx.arcTo(x2,y2,x2,y1,c.r),ctx.lineTo(x2,y1)),3!==i&&ctx.lineTo(coord[i+1][0],coord[i+1][1])}),ctx.closePath()},_cutJigsaw=ctx=>{if(!ctx)return;ctx.shadowColor="black",ctx.shadowBlur=10,ctx.lineWidth=.45,ctx.strokeStyle="#fff9e6",ctx.save(),ctx.stroke(),ctx.globalCompositeOperation="destination-in",ctx.fill(),ctx.globalCompositeOperation="source-over";let sum=8;for(;sum--;)ctx.restore(),ctx.stroke();ctx.restore()},_drawInnerShadow=(ctx,c)=>{if(!ctx)return;let shadowColor="30,30,30",mid=c.mid;ctx.shadowColor="rbga(30,30,30,.7)",ctx.shadowBlur=10,ctx.shadowOffsetX=ctx.shadowOffsetY=4,ctx.lineWidth=1.6,ctx.strokeStyle="#fff9e6",ctx.stroke(),ctx.save();let grd=ctx.createRadialGradient(mid[0],mid[1],c.w,mid[0],mid[1],3);grd.addColorStop(0,"rgba(0,0,0,1)"),grd.addColorStop(.3,"rgba(10,10,10,.9)"),grd.addColorStop(.5,"rgba(30,30,30,.6)"),grd.addColorStop(1,"rgba(30,30,30,.2)"),ctx.fillStyle=grd,ctx.fill(),ctx.restore()};function ScrollCheck(opts){this instanceof ScrollCheck&&this._init(opts)}function initScrollCheck(opts){if(window.document.createElement("canvas").getContext)return new ScrollCheck(opts);{let msg="Your browser doesn’t support HTML5!\nRecommend use Chrome 14+/IE 9+/Firefox 7+/Safari 4+";return error(msg),alert(msg),{}}}return ScrollCheck.prototype={constructor:ScrollCheck,_init(opts){let w=opts.width,h=opts.height;const inputResult=shuldUseInput(opts.input,w,h);if(inputResult)w=inputResult.w||w,h=inputResult.h||h,this.input=inputResult.input||inputResult.dom,this.inputType=inputResult.inputType;else if(opts.createConfig)return error("No input and can’t CreateScrollCheck");let ctx=initCanvas(opts.ctx,w,h),piece=opts.piece,segment=opts.segment,hasScroll=isDef(opts.scrollCtx);w=ctx.w,h=ctx.h,this.w=w,this.h=h,this.ctx=ctx.ctx,this.scrollCtx=hasScroll?initCanvas(opts.scrollCtx,w,h).ctx:ctx.ctx,hasScroll||(this.ctxEqual=!0),this.trimArr=[w,h],isDef(piece)&&isDef(segment)&&(w%piece==0&&h%segment==0?(this.trimArr[2]=piece,this.trimArr[3]=segment):error("invalid piece or sengment.It will be generated automatically!")),opts.createConfig&&(this.bC=initCreateConfig(opts.createConfig),this._initCreateScrollCheck(opts.changeCallback,opts.autoMakeData)),opts.handlerScrollDom&&(this.moveStop=opts.moveStop||!1,this.initHandlerScrollDom(opts.handlerScrollDom,opts.offsetScroll,opts.scrrollContainer)),opts.scrollData&&opts.finishData&&opts.coefficient&&(this.finishData=opts.finishData,this.scrollData=opts.scrollData,this.coefficient=opts.coefficient,this.originalData=opts.originalData,this.putData())},_initCreateScrollCheck(changeCallback,isMake){this.iniCutConfig=(()=>{const bC=Object.assign({},this.bC);return this.verifyValue=makeP(bC,this.w,this.h),bC.direction=makeD(bC.oDirection),this.config=bC,this.verifyValue}),this.getScrollData=(ctx=>{(ctx=ctx||this.scrollCtx).putImageData(this.originalData,0,0),_drawPath(ctx,this.config),_cutJigsaw(ctx),this.scrollData=ctx.getImageData(...this.config.cut);let temCtx=initCanvas("",this.scrollData.width,this.scrollData.height).ctx;return temCtx.putImageData(this.scrollData,0,0),this.scrollUrl=temCtx.canvas.toDataURL()}),this.getFinishData=(ctx=>(ctx=ctx||this.ctx,_drawPath(ctx,this.config),_drawInnerShadow(ctx,this.config),this.coefficient=transformData(ctx,this.trimArr),this.finishData=ctx.getImageData(0,0,this.w,this.h),this.finishUrl=ctx.canvas.toDataURL(),{coefficient:this.coefficient,dataURL:this.finishUrl})),this.putCreateOriginalData=(imgData=>(imgData||(imgData="canvas"==this.inputType?this.input.getImageData(0,0,this.w,this.h):this.input),imgData&&(imgData.data?this.ctx.putImageData(imgData,0,0):this.ctx.drawImage(imgData,0,0,this.w,this.h)),this.originalData=this.ctx.getImageData(0,0,this.w,this.h))),this.autoMakeData=(()=>{this.verifyValue=this.iniCutConfig(),"input"!=this.inputType&&this.putCreateOriginalData(),this.getScrollData(),this.ctxEqual&&this.reDrawCreateCtx(),this.getFinishData(),this.ctxEqual&&this.reDrawCreateCtx(),isMake&&this.drawScrollCheck()}),this.reDrawCreateCtx=(()=>this.ctx.putImageData(this.originalData,0,0)),"input"==this.inputType?this.input.onchange=(event=>{let files=this.input.files[0];if(files){const reader=new FileReader;reader.readAsDataURL(files),reader.onload=(e=>renderImg(e.target.result).then(image=>{this.putCreateOriginalData(image),isMake&&this.autoMakeData(),changeCallback&&changeCallback(e.target.result,image)}))}}):isMake&&this.autoMakeData()},putData(){this.putScrollData(),this.putFinishData(),this.putOriginalData()},putScrollData(scrollData,w,h){scrollData=scrollData||this.scrollData,this.scrollCtx.clearRect(0,0,this.w,this.h),this.getCtxImageData(scrollData,w,h).then(_d=>{this.scrollData=_d,this.scrollCtx.putImageData(_d,0,0)})},putFinishData(finishData){finishData=finishData||this.finishData,this.ctx.clearRect(0,0,this.w,this.h),this.getCtxImageData(finishData).then(_d=>{this.finishData=_d,this.ctx.putImageData(_d,0,0),transformData(this.ctx,this.trimArr,this.coefficient)})},putOriginalData(originalData){(originalData=originalData||this.originalData)&&this.getCtxImageData(originalData).then(_d=>{this.originalData=_d})},getCtxImageData(ctxImg,width,height){let result,w=width||this.w,h=height||this.h;const getData=image=>{let originalData=this.ctx.getImageData(0,0,w,h);this.ctx.drawImage(image,0,0,w,h);let d=this.ctx.getImageData(0,0,w,h);return this.ctx.putImageData(originalData,0,0),d};if(ctxImg instanceof ImageData)result=ctxImg;else if(1==ctxImg.nodeType&&"img"==ctxImg.tagName.toLowerCase())result=getData(ctxImg);else if(judgeType(ctxImg,"string")){let img=getDom(ctxImg);if(!img)return renderImg(ctxImg).then(image=>new Promise(res=>res(getData(image))));result=getData(img)}return new Promise((res,rej)=>{res(result)})},initHandlerScrollDom(dom,offset=0,scrrollContainer){if(dom=getDom(dom),(scrrollContainer=getDom(scrrollContainer))||(scrrollContainer=dom),dom){let offsetX,canDraw=!1;const range=[offset,this.w-dom.offsetWidth-offset];dom.addEventListener("mousedown",e=>{canDraw=!0,offsetX=e.pageX},!1),scrrollContainer.addEventListener("mousemove",e=>{if(canDraw){let move=e.pageX-offsetX;move>=range[0]&&move<=range[1]&&(dom.style.transform=`translate(${move}px, 0px)`,this.drawScrollCheck(move))}},!1);const cancelHandle=e=>{canDraw=!1,offsetX=0,dom.style.transform=`translate(${range[0]}px, 0px)`,this.drawScrollCheck(0)};scrrollContainer.addEventListener("mouseup",e=>{canDraw=!1;let move=e.pageX-offsetX;"function"==typeof this.moveStop?this.moveStop(cancelHandle,move,e):cancelHandle(e)},!1),scrrollContainer.addEventListener("mouseleave",cancelHandle,!1)}else error("initHandlerScrollDom failed!")},drawScrollCheck(offset=0){this.scrollData&&(this.scrollCtx.clearRect(0,0,this.w,this.h),this.scrollCtx.putImageData(this.scrollData,offset,0))}},initScrollCheck});